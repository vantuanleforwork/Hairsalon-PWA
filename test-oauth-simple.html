<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple OAuth Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-2xl mx-auto">
        <div class="bg-white rounded-lg shadow-md p-6">
            <h1 class="text-2xl font-bold mb-4">üîê Simple OAuth Test</h1>
            
            <!-- Config Status -->
            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                <h3 class="font-semibold mb-2">üìã Config Status</h3>
                <div id="configStatus" class="text-sm text-gray-600">Checking...</div>
            </div>
            
            <!-- Auth Functions Status -->
            <div class="mb-6 p-4 bg-yellow-50 rounded-lg">
                <h3 class="font-semibold mb-2">üîß Auth Functions</h3>
                <div id="authFunctionsStatus" class="text-sm text-gray-600">Checking...</div>
                <button onclick="checkAuthFunctions()" class="mt-2 px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                    üîÑ Refresh Check
                </button>
            </div>
            
            <!-- OAuth Test Buttons -->
            <div class="mb-6 p-4 bg-green-50 rounded-lg">
                <h3 class="font-semibold mb-2">üß™ OAuth Tests</h3>
                <div class="space-x-2 mb-4">
                    <button onclick="testDirectLogin()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                        üöÄ Test Login
                    </button>
                    <button onclick="testLogout()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                        üö™ Test Logout
                    </button>
                    <button onclick="testMockLogin()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                        üé≠ Mock Login
                    </button>
                </div>
                <div id="authResult" class="text-sm text-gray-600">No test run yet</div>
            </div>
            
            <!-- User Info -->
            <div class="mb-6 p-4 bg-purple-50 rounded-lg">
                <h3 class="font-semibold mb-2">üë§ Current User</h3>
                <div id="userInfo" class="text-sm text-gray-600">No user logged in</div>
            </div>
            
            <!-- Console Logs -->
            <div class="p-4 bg-gray-50 rounded-lg">
                <h3 class="font-semibold mb-2">üìù Console Logs</h3>
                <div id="consoleLogs" class="text-xs text-gray-500 max-h-40 overflow-y-auto font-mono">
                    Starting OAuth test...<br>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Scripts -->
    <script src="config.js"></script>
    <script src="js/auth.js"></script>

    <script>
        let currentUser = null;

        // Custom console log to show in UI
        function logToUI(message) {
            const logsDiv = document.getElementById('consoleLogs');
            const timestamp = new Date().toLocaleTimeString();
            logsDiv.innerHTML += `<span class="text-blue-600">[${timestamp}]</span> ${message}<br>`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        // Check config status
        function checkConfigStatus() {
            const statusDiv = document.getElementById('configStatus');
            
            if (typeof APP_CONFIG === 'undefined') {
                statusDiv.innerHTML = '‚ùå APP_CONFIG not found';
                logToUI('‚ùå APP_CONFIG not found');
                return;
            }

            const hasRealClientId = APP_CONFIG.GOOGLE_CLIENT_ID && !APP_CONFIG.GOOGLE_CLIENT_ID.includes('DEMO');
            const hasRealAPI = APP_CONFIG.API_BASE_URL && !APP_CONFIG.API_BASE_URL.includes('DEMO');

            statusDiv.innerHTML = `
                ‚úÖ Config loaded<br>
                üîê OAuth Client: ${hasRealClientId ? 'REAL' : 'DEMO'}<br>
                üì° API URL: ${hasRealAPI ? 'REAL' : 'DEMO'}<br>
                üìß Allowed Emails: ${APP_CONFIG.ALLOWED_EMAILS?.length || 0}
            `;

            logToUI(`‚úÖ Config loaded - OAuth: ${hasRealClientId ? 'REAL' : 'DEMO'}, API: ${hasRealAPI ? 'REAL' : 'DEMO'}`);
        }

        // Check auth functions availability
        function checkAuthFunctions() {
            const statusDiv = document.getElementById('authFunctionsStatus');
            
            const functions = {
                'window.initAuth': typeof window.initAuth,
                'window.loginWithGoogle': typeof window.loginWithGoogle,
                'window.logoutUser': typeof window.logoutUser,
                'global loginWithGoogle': typeof loginWithGoogle,
                'global logoutUser': typeof logoutUser,
                'AUTH object': typeof AUTH,
                'google.accounts': typeof google?.accounts
            };

            let html = '';
            for (const [name, type] of Object.entries(functions)) {
                const status = type === 'function' ? '‚úÖ' : type === 'object' ? 'üîß' : '‚ùå';
                html += `${status} ${name}: ${type}<br>`;
            }

            statusDiv.innerHTML = html;
            logToUI('üîç Auth functions checked');
        }

        // Test direct login
        function testDirectLogin() {
            logToUI('üöÄ Testing direct login...');
            
            // Try multiple methods
            if (typeof window.loginWithGoogle === 'function') {
                logToUI('‚úÖ Found window.loginWithGoogle');
                try {
                    window.loginWithGoogle();
                    updateAuthResult('‚úÖ Login function called', 'success');
                } catch (e) {
                    logToUI('‚ùå Error calling loginWithGoogle: ' + e.message);
                    updateAuthResult('‚ùå Error: ' + e.message, 'error');
                }
            } else if (typeof loginWithGoogle === 'function') {
                logToUI('‚úÖ Found global loginWithGoogle');
                try {
                    loginWithGoogle();
                    updateAuthResult('‚úÖ Global login function called', 'success');
                } catch (e) {
                    logToUI('‚ùå Error calling global loginWithGoogle: ' + e.message);
                    updateAuthResult('‚ùå Error: ' + e.message, 'error');
                }
            } else {
                logToUI('‚ùå No login function found');
                updateAuthResult('‚ùå No login function available', 'error');
                
                // Try to initialize first
                if (typeof window.initAuth === 'function') {
                    logToUI('üîÑ Trying to initialize auth first...');
                    try {
                        window.initAuth();
                        setTimeout(() => {
                            testDirectLogin(); // Retry after init
                        }, 1000);
                    } catch (e) {
                        logToUI('‚ùå Init auth failed: ' + e.message);
                    }
                }
            }
        }

        // Test logout
        function testLogout() {
            logToUI('üö™ Testing logout...');
            
            if (typeof window.logoutUser === 'function') {
                try {
                    window.logoutUser();
                    logToUI('‚úÖ Logout function called');
                } catch (e) {
                    logToUI('‚ùå Error calling logout: ' + e.message);
                }
            } else if (typeof logoutUser === 'function') {
                try {
                    logoutUser();
                    logToUI('‚úÖ Global logout function called');
                } catch (e) {
                    logToUI('‚ùå Error calling global logout: ' + e.message);
                }
            } else {
                logToUI('‚ùå No logout function found');
            }
            
            // Always reset UI state
            currentUser = null;
            updateUserInfo(null);
            updateAuthResult('üö™ Logged out', 'info');
        }

        // Test mock login
        function testMockLogin() {
            logToUI('üé≠ Testing mock login...');
            
            const mockUser = {
                id: 'mock-123',
                email: 'test@example.com',
                name: 'Test User',
                picture: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+PGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTIiIGZpbGw9IiNlNWU3ZWIiLz48dGV4dCB4PSIxMiIgeT0iMTYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM2YjczODAiIGZvbnQtc2l6ZT0iMTAiPvCfkYQ8L3RleHQ+PC9zdmc+'
            };
            
            currentUser = mockUser;
            updateUserInfo(mockUser);
            updateAuthResult('‚úÖ Mock login successful', 'success');
            logToUI('‚úÖ Mock login successful');
        }

        // Update auth result display
        function updateAuthResult(message, type = 'info') {
            const resultDiv = document.getElementById('authResult');
            const colors = {
                success: 'text-green-600',
                error: 'text-red-600',
                info: 'text-blue-600'
            };
            resultDiv.innerHTML = `<span class="${colors[type] || colors.info}">${message}</span>`;
        }

        // Update user info display
        function updateUserInfo(user) {
            const userDiv = document.getElementById('userInfo');
            
            if (user) {
                userDiv.innerHTML = `
                    <div class="space-y-1">
                        <div><strong>ID:</strong> ${user.id}</div>
                        <div><strong>Name:</strong> ${user.name}</div>
                        <div><strong>Email:</strong> ${user.email}</div>
                        <div><strong>Picture:</strong> <img src="${user.picture}" alt="avatar" class="inline w-6 h-6 rounded-full ml-2"></div>
                    </div>
                `;
            } else {
                userDiv.innerHTML = '<span class="text-gray-500">No user logged in</span>';
            }
        }

        // Global auth success handler (for OAuth callback)
        window.handleAuthSuccess = function(user) {
            logToUI('üéâ Global auth success callback: ' + user.email);
            currentUser = user;
            updateUserInfo(user);
            updateAuthResult('‚úÖ OAuth login successful', 'success');
        };

        // Global auth error handler
        window.handleAuthError = function(error) {
            logToUI('‚ùå Global auth error callback: ' + error);
            updateAuthResult('‚ùå OAuth error: ' + error, 'error');
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            logToUI('üîÑ Page loaded, initializing...');
            
            setTimeout(() => {
                checkConfigStatus();
                checkAuthFunctions();
                
                // Try to auto-initialize auth
                if (typeof window.initAuth === 'function') {
                    logToUI('üîÑ Auto-initializing auth...');
                    try {
                        window.initAuth();
                    } catch (e) {
                        logToUI('‚ùå Auto-init failed: ' + e.message);
                    }
                }
            }, 500);
        });
    </script>
</body>
</html>
